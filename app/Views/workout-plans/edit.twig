{% extends "layouts/base.twig" %}

{% block title %}Edit Workout Plan - {{ plan.plan_name }}{% endblock %}
{% block page_title %}Edit Workout Plan{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url('/dashboard') }}">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{{ url('/workout-plans') }}">Workout Plans</a></li>
            <li class="breadcrumb-item"><a href="{{ url('/workout-plans/view?id=' ~ plan.id) }}">{{ plan.plan_name }}</a></li>
            <li class="breadcrumb-item active">Edit</li>
        </ol>
    </nav>
</div>

{% if error %}
<div class="alert alert-danger">
    <i class="bi bi-exclamation-triangle"></i> {{ error }}
</div>
{% endif %}

{% if success %}
<div class="alert alert-success">
    <i class="bi bi-check-circle"></i> {{ success }}
</div>
{% endif %}

<div class="row">
    <!-- Edit Form -->
    <div class="col-lg-8">
        <div class="card form-custom">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-pencil"></i> Edit Workout Plan</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url('/workout-plans/update') }}" id="editPlanForm">
                    <input type="hidden" name="id" value="{{ plan.id }}">
                    
                    <!-- Basic Information -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-muted border-bottom pb-2">Basic Information</h6>
                        </div>
                        <div class="col-md-6">
                            <label for="plan_name" class="form-label required">Plan Name</label>
                            <input type="text" class="form-control" name="plan_name" id="plan_name" 
                                   value="{{ plan.plan_name }}" required>
                            <div class="invalid-feedback"></div>
                        </div>
                        <div class="col-md-6">
                            <label for="plan_type" class="form-label required">Plan Type</label>
                            <select class="form-select" name="plan_type" id="plan_type" required>
                                <option value="">Select Plan Type</option>
                                <option value="Weight Loss" {% if plan.plan_type == 'Weight Loss' %}selected{% endif %}>Weight Loss</option>
                                <option value="Muscle Gain" {% if plan.plan_type == 'Muscle Gain' %}selected{% endif %}>Muscle Gain</option>
                                <option value="Strength Training" {% if plan.plan_type == 'Strength Training' %}selected{% endif %}>Strength Training</option>
                                <option value="Cardio" {% if plan.plan_type == 'Cardio' %}selected{% endif %}>Cardio</option>
                                <option value="Flexibility" {% if plan.plan_type == 'Flexibility' %}selected{% endif %}>Flexibility</option>
                                <option value="Sports Specific" {% if plan.plan_type == 'Sports Specific' %}selected{% endif %}>Sports Specific</option>
                                <option value="Rehabilitation" {% if plan.plan_type == 'Rehabilitation' %}selected{% endif %}>Rehabilitation</option>
                                <option value="General Fitness" {% if plan.plan_type == 'General Fitness' %}selected{% endif %}>General Fitness</option>
                            </select>
                            <div class="invalid-feedback"></div>
                        </div>
                        <div class="col-12 mt-3">
                            <label for="plan_description" class="form-label required">Plan Description</label>
                            <textarea class="form-control" name="plan_description" id="plan_description" rows="3" required>{{ plan.plan_description }}</textarea>
                            <div class="invalid-feedback"></div>
                        </div>
                    </div>

                    <!-- Member and Trainer Assignment -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-muted border-bottom pb-2">Assignment</h6>
                        </div>
                        <div class="col-md-6">
                            <label for="member_id" class="form-label required">Member</label>
                            <select class="form-select" name="member_id" id="member_id" required>
                                <option value="">Select Member</option>
                                {% for member in members %}
                                <option value="{{ member.id }}" 
                                        data-membership="{{ member.membership_type }}"
                                        data-email="{{ member.email }}"
                                        {% if plan.member_id == member.id %}selected{% endif %}>
                                    {{ member.first_name }} {{ member.last_name }} ({{ member.membership_type }})
                                </option>
                                {% endfor %}
                            </select>
                            <div class="invalid-feedback"></div>
                        </div>
                        <div class="col-md-6">
                            <label for="trainer_id" class="form-label required">Assigned Trainer</label>
                            <select class="form-select" name="trainer_id" id="trainer_id" required>
                                <option value="">Select Trainer</option>
                                {% for trainer in trainers %}
                                <option value="{{ trainer.id }}"
                                        data-specialization="{{ trainer.specialization }}"
                                        data-rate="{{ trainer.hourly_rate }}"
                                        {% if plan.trainer_id == trainer.id %}selected{% endif %}>
                                    {{ trainer.first_name }} {{ trainer.last_name }} - {{ trainer.specialization }}
                                </option>
                                {% endfor %}
                            </select>
                            <div class="invalid-feedback"></div>
                        </div>
                    </div>

                    <!-- Schedule Information -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-muted border-bottom pb-2">Schedule</h6>
                        </div>
                        <div class="col-md-4">
                            <label for="start_date" class="form-label required">Start Date</label>
                            <input type="date" class="form-control" name="start_date" id="start_date" 
                                   value="{{ plan.start_date }}" required>
                            <div class="invalid-feedback"></div>
                        </div>
                        <div class="col-md-4">
                            <label for="end_date" class="form-label required">End Date</label>
                            <input type="date" class="form-control" name="end_date" id="end_date" 
                                   value="{{ plan.end_date }}" required>
                            <div class="invalid-feedback"></div>
                        </div>
                        <div class="col-md-4">
                            <label for="duration_weeks" class="form-label">Duration</label>
                            <input type="text" class="form-control" id="duration_weeks" readonly 
                                   placeholder="Auto-calculated">
                        </div>
                    </div>

                    <!-- Plan Details -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-muted border-bottom pb-2">Plan Details</h6>
                        </div>
                        <div class="col-md-4">
                            <label for="sessions_per_week" class="form-label">Sessions per Week</label>
                            <select class="form-select" name="sessions_per_week" id="sessions_per_week">
                                <option value="">Select Frequency</option>
                                <option value="1" {% if plan.sessions_per_week == 1 %}selected{% endif %}>1 session/week</option>
                                <option value="2" {% if plan.sessions_per_week == 2 %}selected{% endif %}>2 sessions/week</option>
                                <option value="3" {% if plan.sessions_per_week == 3 %}selected{% endif %}>3 sessions/week</option>
                                <option value="4" {% if plan.sessions_per_week == 4 %}selected{% endif %}>4 sessions/week</option>
                                <option value="5" {% if plan.sessions_per_week == 5 %}selected{% endif %}>5 sessions/week</option>
                                <option value="6" {% if plan.sessions_per_week == 6 %}selected{% endif %}>6 sessions/week</option>
                                <option value="7" {% if plan.sessions_per_week == 7 %}selected{% endif %}>7 sessions/week</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="session_duration" class="form-label">Session Duration (minutes)</label>
                            <input type="number" class="form-control" name="session_duration" id="session_duration" 
                                   min="15" max="180" step="15" value="{{ plan.session_duration }}">
                        </div>
                        <div class="col-md-4">
                            <label for="difficulty_level" class="form-label">Difficulty Level</label>
                            <select class="form-select" name="difficulty_level" id="difficulty_level">
                                <option value="">Select Level</option>
                                <option value="Beginner" {% if plan.difficulty_level == 'Beginner' %}selected{% endif %}>Beginner</option>
                                <option value="Intermediate" {% if plan.difficulty_level == 'Intermediate' %}selected{% endif %}>Intermediate</option>
                                <option value="Advanced" {% if plan.difficulty_level == 'Advanced' %}selected{% endif %}>Advanced</option>
                                <option value="Expert" {% if plan.difficulty_level == 'Expert' %}selected{% endif %}>Expert</option>
                            </select>
                        </div>
                    </div>

                    <!-- Additional Information -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-muted border-bottom pb-2">Additional Information</h6>
                        </div>
                        <div class="col-md-6">
                            <label for="goals" class="form-label">Primary Goals</label>
                            <textarea class="form-control" name="goals" id="goals" rows="3">{{ plan.goals }}</textarea>
                        </div>
                        <div class="col-md-6">
                            <label for="notes" class="form-label">Special Notes/Instructions</label>
                            <textarea class="form-control" name="notes" id="notes" rows="3">{{ plan.notes }}</textarea>
                        </div>
                        <div class="col-md-6 mt-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="is_active" id="is_active" 
                                       {% if plan.is_active %}checked{% endif %}>
                                <label class="form-check-label" for="is_active">
                                    Plan is active
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="row">
                        <div class="col-12">
                            <hr>
                            <div class="d-flex justify-content-between">
                                <a href="{{ url('/workout-plans/view?id=' ~ plan.id) }}" class="btn btn-outline-secondary">
                                    <i class="bi bi-arrow-left"></i> Cancel
                                </a>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-check"></i> Update Plan
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Plan Summary -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-info-circle"></i> Current Plan Info</h6>
            </div>
            <div class="card-body">
                <div class="text-center mb-3">
                    <i class="bi bi-clipboard-check" style="font-size: 3rem; color: var(--primary-color);"></i>
                    <h5 class="mt-2">{{ plan.plan_name }}</h5>
                </div>
                
                <div class="plan-summary">
                    <div class="summary-item">
                        <strong>Member:</strong> {{ plan.member_name }}
                    </div>
                    <div class="summary-item">
                        <strong>Trainer:</strong> {{ plan.trainer_name }}
                    </div>
                    <div class="summary-item">
                        <strong>Start:</strong> {{ plan.start_date|date("M d, Y") }}
                    </div>
                    <div class="summary-item">
                        <strong>End:</strong> {{ plan.end_date|date("M d, Y") }}
                    </div>
                    <div class="summary-item">
                        <strong>Status:</strong> 
                        <span class="badge {% if plan.is_active %}bg-success{% else %}bg-secondary{% endif %}">
                            {% if plan.is_active %}Active{% else %}Inactive{% endif %}
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-lightning"></i> Quick Actions</h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url('/workout-plans/view?id=' ~ plan.id) }}" class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-eye"></i> View Plan
                    </a>
                    <a href="{{ url('/members/view?id=' ~ plan.member_id) }}" class="btn btn-outline-success btn-sm">
                        <i class="bi bi-person"></i> View Member
                    </a>
                    <a href="{{ url('/trainers/view?id=' ~ plan.trainer_id) }}" class="btn btn-outline-info btn-sm">
                        <i class="bi bi-person-badge"></i> View Trainer
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.plan-summary .summary-item {
    margin-bottom: 10px;
    padding: 5px 0;
    border-bottom: 1px solid #f0f0f0;
}

.plan-summary .summary-item:last-child {
    border-bottom: none;
}
</style>
{% endblock %}

{% block scripts %}
<script>
// Date calculation
document.getElementById('start_date').addEventListener('change', calculateDuration);
document.getElementById('end_date').addEventListener('change', calculateDuration);

function calculateDuration() {
    const startDate = new Date(document.getElementById('start_date').value);
    const endDate = new Date(document.getElementById('end_date').value);
    
    if (startDate && endDate && endDate > startDate) {
        const diffTime = Math.abs(endDate - startDate);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        const weeks = Math.round(diffDays / 7);
        document.getElementById('duration_weeks').value = `${weeks} week${weeks > 1 ? 's' : ''} (${diffDays} days)`;
    } else {
        document.getElementById('duration_weeks').value = '';
    }
}

// Initialize duration calculation
calculateDuration();

// Form validation
document.getElementById('editPlanForm').addEventListener('submit', function(e) {
    const startDate = new Date(document.getElementById('start_date').value);
    const endDate = new Date(document.getElementById('end_date').value);
    
    if (endDate <= startDate) {
        e.preventDefault();
        alert('End date must be after start date.');
        return;
    }
});
</script>
{% endblock %}

