{% extends "layouts/base.twig" %}

{% block title %}View Workout Plan - {{ workoutPlan.plan_name }}{% endblock %}
{% block page_title %}Workout Plan Details{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url('/dashboard') }}">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{{ url('/workout-plans') }}">Workout Plans</a></li>
            <li class="breadcrumb-item active">{{ workoutPlan.plan_name }}</li>
        </ol>
    </nav>
    <a href="{{ url('/workout-plans/edit?id=' ~ workoutPlan.id) }}" class="btn btn-primary">
        <i class="bi bi-pencil"></i> Edit Plan
    </a>
</div>

<div class="row">
    <!-- Plan Information -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-clipboard-check"></i> {{ workoutPlan.plan_name }}</h5>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h6 class="text-muted">Plan Details</h6>
                        <div class="plan-info">
                            <div class="info-item">
                                <strong>Description:</strong> {{ plan.plan_description }}
                            </div>
                            <div class="info-item">
                                <strong>Start Date:</strong> {{ plan.start_date|date("M d, Y") }}
                            </div>
                            <div class="info-item">
                                <strong>End Date:</strong> {{ plan.end_date|date("M d, Y") }}
                            </div>
                            <div class="info-item">
                                <strong>Status:</strong>
                                {% if plan.is_active %}
                                    <span class="badge bg-success">Active</span>
                                {% else %}
                                    <span class="badge bg-secondary">Inactive</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-muted">Assignment</h6>
                        <div class="plan-info">
                            <div class="info-item">
                                <strong>Member:</strong> 
                                <a href="{{ url('/members/view?id=' ~ plan.member_id) }}">
                                    {{ plan.member_name }}
                                </a>
                            </div>
                            <div class="info-item">
                                <strong>Trainer:</strong> 
                                <a href="{{ url('/trainers/view?id=' ~ plan.trainer_id) }}">
                                    {{ plan.trainer_name }}
                                </a>
                            </div>
                            <div class="info-item">
                                <strong>Created:</strong> {{ plan.created_at|date("M d, Y") }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Progress Bar -->
                {% set today = date() %}
                {% set startDate = date(plan.start_date) %}
                {% set endDate = date(plan.end_date) %}
                {% set totalDays = endDate.diff(startDate).days + 1 %}
                {% set daysPassed = today.diff(startDate).days + 1 %}
                
                {% if daysPassed < 0 %}
                    {% set progress = 0 %}
                {% elseif daysPassed > totalDays %}
                    {% set progress = 100 %}
                {% else %}
                    {% set progress = (daysPassed / totalDays * 100)|round %}
                {% endif %}

                <div class="mb-4">
                    <h6 class="text-muted">Progress ({{ progress }}%)</h6>
                    <div class="progress mb-2" style="height: 10px;">
                        <div class="progress-bar bg-{% if progress == 100 %}success{% elseif progress > 70 %}info{% elseif progress > 30 %}warning{% else %}primary{% endif %}" 
                             style="width: {{ progress }}%"></div>
                    </div>
                    <small class="text-muted">Day {{ daysPassed > 0 ? daysPassed : 1 }} of {{ totalDays }}</small>
                </div>

                <!-- Plan Description -->
                {% if plan.goals or plan.notes %}
                <div class="row mb-4">
                    {% if plan.goals %}
                    <div class="col-md-6">
                        <h6 class="text-muted">Goals</h6>
                        <p class="text-muted">{{ plan.goals }}</p>
                    </div>
                    {% endif %}
                    {% if plan.notes %}
                    <div class="col-md-6">
                        <h6 class="text-muted">Notes</h6>
                        <p class="text-muted">{{ plan.notes }}</p>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Exercises -->
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-list-task"></i> Workout Exercises</h6>
            </div>
            <div class="card-body">
                {% if plan.exercises %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Exercise</th>
                                <th>Sets</th>
                                <th>Reps</th>
                                <th>Rest</th>
                                <th>Weight</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for exercise in plan.exercises %}
                            <tr>
                                <td><strong>{{ exercise.name }}</strong></td>
                                <td>{{ exercise.sets }}</td>
                                <td>{{ exercise.reps }}</td>
                                <td>{{ exercise.rest }}s</td>
                                <td>{{ exercise.weight ? exercise.weight ~ ' lbs' : '-' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4 text-muted">
                    <i class="bi bi-list-task fs-1 d-block mb-2 opacity-50"></i>
                    No exercises added yet
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Plan Summary -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-info-circle"></i> Plan Summary</h6>
            </div>
            <div class="card-body">
                <div class="plan-stats">
                    <div class="stat-item">
                        <h5>{{ totalDays }}</h5>
                        <small class="text-muted">Total Days</small>
                    </div>
                    <div class="stat-item">
                        <h5>{{ plan.sessions_per_week|default(0) }}</h5>
                        <small class="text-muted">Sessions/Week</small>
                    </div>
                    <div class="stat-item">
                        <h5>{{ plan.session_duration|default(0) }}</h5>
                        <small class="text-muted">Minutes/Session</small>
                    </div>
                    <div class="stat-item">
                        <h5>{{ plan.difficulty_level|default('N/A') }}</h5>
                        <small class="text-muted">Difficulty</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-lightning"></i> Quick Actions</h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url('/workout-plans/edit?id=' ~ plan.id) }}" class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-pencil"></i> Edit Plan
                    </a>
                    <a href="{{ url('/members/view?id=' ~ plan.member_id) }}" class="btn btn-outline-success btn-sm">
                        <i class="bi bi-person"></i> View Member
                    </a>
                    <a href="{{ url('/trainers/view?id=' ~ plan.trainer_id) }}" class="btn btn-outline-info btn-sm">
                        <i class="bi bi-person-badge"></i> View Trainer
                    </a>
                    <button class="btn btn-outline-danger btn-sm" onclick="confirmDelete()">
                        <i class="bi bi-trash"></i> Delete Plan
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.plan-info .info-item {
    margin-bottom: 10px;
    padding: 5px 0;
    border-bottom: 1px solid #f0f0f0;
}

.plan-info .info-item:last-child {
    border-bottom: none;
}

.plan-stats {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    text-align: center;
}

.stat-item h5 {
    margin-bottom: 5px;
    color: var(--primary-color);
}
</style>
{% endblock %}

{% block scripts %}
<script>
function confirmDelete() {
    if (confirm('Are you sure you want to delete this workout plan? This action cannot be undone.')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = window.APP_BASE_PATH + '/workout-plans/delete';
        
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'id';
        input.value = '{{ plan.id }}';
        
        form.appendChild(input);
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
{% endblock %}

